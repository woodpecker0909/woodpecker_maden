<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>붙박이장 자동 설계 계산기 • Compact 시퀀스</title>
<style>
  :root{
    --brand:#0f7bff;
    --ink:#1f2937;
    --muted:#6b7280;
    --card:#ffffff;
    --line:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;color:var(--ink);background:#f5f7fb}
  .container{max-width:1000px;margin:0 auto;padding:20px 14px 160px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
  h1{margin:0 0 6px;font-size:20px}
  h2{margin:0 0 10px;font-size:16px}
  .muted{color:var(--muted);font-size:13px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:760px){.row{grid-template-columns:1fr}}
  .btn{border:0;border-radius:10px;background:var(--brand);color:#fff;padding:8px 12px;cursor:pointer;font-size:14px}
  .btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}
  .summary-line{margin:8px 0}
  .checks{display:flex;gap:12px;flex-wrap:wrap}
  label.inline{display:flex;align-items:center;gap:8px}
  input[type="number"]{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:8px}
  .slot{border:1px solid #e5f0f5;border-radius:12px;padding:10px;margin-bottom:12px}
  .slot h3{margin:0 0 8px;font-size:14px;display:flex;justify-content:space-between;align-items:center}
  .chip{font-size:11px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe}
  .thumb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .thumb{background:#fff;border-radius:10px;overflow:hidden;border:2px solid transparent;cursor:pointer}
  .thumb img{display:block;width:100%;height:auto}
  .thumb.active{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.2)}
  .preview-wrap{display:flex;flex-direction:column;gap:8px}
  .preview-box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff;display:flex;justify-content:center;align-items:center;min-height:120px;overflow:auto}
  .seq{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;word-break:break-all}
  .sticky-bar{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.96);border-top:1px solid var(--line);backdrop-filter:blur(6px);padding:10px 14px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .ok{color:#087443}
  .warn{color:#b00020}
  small.helper{display:block;color:#475569;margin-top:6px}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>📐 붙박이장 자동 설계 계산기</h1>
      <div class="muted"><b>실제 폭(mm) 비율·최소 서라운드 40mm 자동</b> · <b>작은장: 너비만 절반(높이 동일)</b> · 큰장 중앙 가상 3mm 표기</div>
    </div>

    <div class="card">
      <h2>입력</h2>
      <div class="summary-line">
        <label>벽 전체 길이 (mm)<br>
          <input id="wall" type="number" value="3700" min="1000" placeholder="예: 3700"/>
        </label>
      </div>
      <div class="summary-line">
        <b>허용 세트(짝 맞춤)</b>
        <div class="checks">
          <label class="inline"><input type="checkbox" id="set1000" checked> 1000 + 500</label>
          <label class="inline"><input type="checkbox" id="set950"  checked> 950 + 475</label>
          <label class="inline"><input type="checkbox" id="set900"  checked> 900 + 450</label>
          <label class="inline"><input type="checkbox" id="set850"  checked> 850 + 425</label>
          <label class="inline"><input type="checkbox" id="set800"  checked> 800 + 400</label>
        </div>
        <small class="muted">문짝 폭 동일 유지: 각 세트 내 큰장/작은장은 2:1 비율(예: 1000↔500, 950↔475)</small>
      </div>

      <div class="summary-line">
        <b>추가 필터</b>
        <div class="checks">
          <label class="inline"><input type="checkbox" id="pairRequired"> 큰장·작은장 모두 포함</label>
          <label class="inline"><input type="checkbox" id="onlyOddDoors"> 홀수 도어만</label>
        </div>
      </div>

      <button class="btn" id="calcBtn">계산하기</button>
      <div id="summary" style="margin-top:10px;"></div>
    </div>

    <div class="card" id="designCard" style="display:none;">
      <h2>디자인 선택 (A~I)</h2>
      <div class="row">
        <div><div id="slotsWrap"></div></div>

        <div class="preview-wrap">
          <div><b>미니 조립 미리보기</b></div>
          <div class="preview-box"><canvas id="previewCanvas"></canvas></div>
          <div class="muted">좌/우 서라운드, 각 통 폭(mm), 큰장 중앙 <b>3mm</b> 표시</div>

          <!-- Compact만 표시 -->
          <div style="margin-top:12px;">
            <label>Compact 시퀀스 (복사 → 스마트스토어 첫 칸에 붙여넣기)</label>
            <div id="sequenceBoxCompact" class="seq">-</div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
              <button class="btn" onclick="copyText('sequenceBoxCompact')">복사</button>
              <small class="helper">복사한 결과는 <b>상품 옵션 첫 칸(사이즈&amp;디자인 구성)</b>에 붙여넣어 주세요.</small>
            </div>
          </div>

          <div style="margin-top:10px;">
            <button class="btn" onclick="downloadPreview()">최종이미지 저장</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="sticky-bar">
    <div class="muted">계산 → 추천안 선택 → 디자인 선택 → 시퀀스 복사/이미지 저장</div>
    <button class="btn" onclick="calculate()">다시 계산</button>
  </div>

<script>
  // ---- 설정 상수 ----
  const MIN_SURROUND = 40;          // 최소 서라운드 mm
  const LEFTOVER_TIE_MM = 20;       // 남는폭 근소차 동률 시 우선순위 보정
  const DOOR_GAP_MM = 3;            // 큰장 중앙 가상 간격(표시용)

  // 세트(짝 맞춤)
  const SETS = [
    { id:"set1000", name:"1000+500", big:1000, small:500, priority:0 },
    { id:"set950",  name:"950+475", big:950,  small:475, priority:1 },
    { id:"set900",  name:"900+450", big:900,  small:450, priority:2 },
    { id:"set850",  name:"850+425", big:850,  small:425, priority:3 },
    { id:"set800",  name:"800+400", big:800,  small:400, priority:4 },
  ];

  // 디자인 문자
  const LETTERS_BIG   = ["A","B","C","D","E","F","G","H","I"];
  const LETTERS_SMALL = ["A","B","C","G","H","I"];

  // 썸네일 파일 (큰장/작은장 별도)
  const THUMBS_BIG   = Object.fromEntries(LETTERS_BIG  .map(ch => [ch, `design_${ch}.png`]));
  const THUMBS_SMALL = Object.fromEntries(LETTERS_SMALL.map(ch => [ch, `s_design_${ch}.png`]));

  let topRows = [], selections = [], currentPlan = null;

  document.getElementById('calcBtn').addEventListener('click', calculate);
  document.getElementById('wall').addEventListener('keydown', e => { if(e.key === 'Enter') calculate(); });

  // ---- 계산 로직 ----
  function calculate(){
    const wall = parseInt(document.getElementById('wall').value,10);
    const pairRequired = document.getElementById('pairRequired').checked;
    const onlyOdd = document.getElementById('onlyOddDoors').checked;

    const summary = document.getElementById('summary');
    summary.innerHTML = "";
    document.getElementById('designCard').style.display = "none";

    if(!wall || wall < 1000){
      summary.innerHTML = `<div class="warn">⚠️ 1000mm 이상 입력하세요.</div>`;
      return;
    }

    const enabledSets = SETS.filter(s => document.getElementById(s.id).checked);
    if(enabledSets.length === 0){
      summary.innerHTML = `<div class="warn">⚠️ 최소 1개 세트를 선택하세요.</div>`;
      return;
    }

    let rows = [];
    for(const set of enabledSets){
      // 실사용 범위를 넉넉히 검색 (최대 14통 가정)
      for(let bc=0; bc<=14; bc++){
        for(let sc=0; sc<=14; sc++){
          if(bc===0 && sc===0) continue;
          if(pairRequired && (bc===0 || sc===0)) continue;

          const used = set.big*bc + set.small*sc;
          if(used > wall) continue;

          const leftover = wall - used;
          const surround = leftover/2;

          if(surround < MIN_SURROUND) continue;

          // 도어 수 = 큰장*2 + 작은장*1 (개념상)
          const doors = 2*bc + sc;
          if(onlyOdd && (doors % 2 === 0)) continue;

          rows.push({ set:set.name, big:set.big, small:set.small, bc, sc, used, leftover, surround, doors, priority:set.priority });
        }
      }
    }

    if(rows.length === 0){
      summary.innerHTML = `<div class="warn">조건에 맞는 조합이 없습니다. (서라운드 ≥ ${MIN_SURROUND}mm)</div>`;
      return;
    }

    rows.sort((a,b)=>{
      const diff = Math.abs(a.leftover - b.leftover);
      if(diff <= LEFTOVER_TIE_MM && a.priority !== b.priority) return a.priority - b.priority; // 세트 우선
      if(a.leftover !== b.leftover) return a.leftover - b.leftover; // 남는폭 최소
      if(a.doors !== b.doors) return a.doors - b.doors;             // 도어 수 최소
      return (a.bc+a.sc) - (b.bc+b.sc);                              // 통 수 최소
    });

    topRows = rows.slice(0,3);

    summary.innerHTML =
      `<div class="ok"><b>✅ 추천 조합 Top3</b></div>` +
      topRows.map((r,i)=>`
        <div class="summary-line">
          <button class="btn ghost" onclick="choosePlan(${i})">${i+1}안 선택</button>
          ${r.set} · 큰장 ${r.bc} · 작은장 ${r.sc} = 총 ${(r.bc+r.sc)}통,
          서라운드 약 ${Math.round(r.surround)}mm/측 (남는폭 ${r.leftover}mm)
        </div>`).join("");
  }

  // ---- 플랜 선택 → 디자인 슬롯 생성 ----
  function choosePlan(idx){
    const r = topRows[idx];
    currentPlan = r;

    const unitCount = r.bc + r.sc;
    const wrap = document.getElementById('slotsWrap');
    wrap.innerHTML = "";
    selections = Array(unitCount).fill("A");

    for(let i=0; i<unitCount; i++){
      const isSmall = (i >= r.bc);
      const letters = isSmall ? LETTERS_SMALL : LETTERS_BIG;
      const defaultLetter = letters[0];
      selections[i] = defaultLetter;

      const mm = isSmall ? r.small : r.big;
      const chip = isSmall ? `<span class="chip">작은장</span>` : `<span class="chip">큰장</span>`;

      const slot = document.createElement('div');
      slot.className = 'slot';
      slot.innerHTML = `<h3>${i+1}통 ${chip} <span class="muted">${mm}mm</span></h3>`;

      const grid = document.createElement('div');
      grid.className = 'thumb-grid';

      letters.forEach(letter=>{
        const div = document.createElement('div');
        div.className = 'thumb' + (letter===defaultLetter ? ' active' : '');
        div.dataset.letter = letter;
        const img = document.createElement('img');
        img.src = isSmall ? THUMBS_SMALL[letter] : THUMBS_BIG[letter];
        img.alt = letter;
        div.appendChild(img);

        div.addEventListener('click', ()=>{
          selections[i] = letter;
          grid.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));
          div.classList.add('active');
          updateSequences();
          renderPreview();
        });

        grid.appendChild(div);
      });

      slot.appendChild(grid);
      wrap.appendChild(slot);
    }

    document.getElementById('designCard').style.display = "block";
    updateSequences();
    renderPreview();
    window.scrollTo({ top: document.getElementById('designCard').offsetTop - 10, behavior:'smooth' });
  }

  // ---- Compact 시퀀스 생성 (예: 40L-9A-9C-4.5G-40R) ----
  function buildCompactSequence(){
    if(!currentPlan) return "-";
    const { bc, big, small, surround } = currentPlan;

    // 숫자 → 디씨미터 표기 (소수 1자리, 1000→10, 450→4.5)
    const toDm = mm => (Math.round(mm)/100).toString().replace(/\.0$/,"");

    // 본문: 각 통의 폭을 디씨미터 표기하고, 숫자 먼저 + 디자인 문자(작은장도 동일 규칙)
    const widths = selections.map((_,i)=> i<bc ? big : small);
    const body = selections.map((ch,i)=> `${toDm(widths[i])}${ch}`).join("-");

    const L = Math.round(surround);   // L/R은 mm 그대로 숫자 먼저
    const R = Math.round(surround);

    return `${L}L-${body}-${R}R`;
  }

  function updateSequences(){
    const compact = buildCompactSequence();
    document.getElementById('sequenceBoxCompact').textContent = compact;
  }

  // ---- 미니 프리뷰 ----
  async function renderPreview(){
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const unitH = 240, labelH = 24, gap = 8;

    if(!currentPlan){ canvas.width=0; canvas.height=0; return; }

    const {bc, sc, big, small, surround} = currentPlan;
    const count = selections.length || 0;
    if(count === 0){ canvas.width=0; canvas.height=0; return; }

    const basePxPerMm = 160/1000;
    let pxPerMm = basePxPerMm;

    const totalMm = bc*big + sc*small;
    let sPx = Math.max(4, Math.round(surround*pxPerMm));
    let totalW = sPx + (totalMm*pxPerMm) + (gap*(count-1)) + sPx;

    const maxW = 1200;
    if(totalW > maxW){
      const mmPart = (totalMm*pxPerMm) + (2*sPx);
      const scale = (maxW - gap*(count-1)) / mmPart;
      pxPerMm *= scale;
      sPx = Math.max(3, Math.round(surround*pxPerMm));
      totalW = Math.round(sPx + (totalMm*pxPerMm) + (gap*(count-1)) + sPx);
    }

    canvas.width = totalW;
    canvas.height = unitH + labelH;

    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Left surround
    let x = 0;
    ctx.fillStyle="#f0f0f0"; ctx.fillRect(x,0,sPx,unitH);
    ctx.strokeStyle="#cfcfcf"; ctx.strokeRect(x+0.5,0.5,sPx-1,unitH-1);
    ctx.fillStyle="#555"; ctx.font="12px system-ui"; ctx.textAlign="center";
    ctx.fillText(`L${Math.round(surround)}mm`, x + sPx/2, unitH - 6);
    x += sPx;

    const unitWidths = selections.map((_,i)=> i<bc ? big : small);

    for(let i=0;i<count;i++){
      const mm = unitWidths[i];
      const slotW = mm*pxPerMm;
      const letter = selections[i];
      const isSmall = (i>=bc);
      const src = isSmall ? THUMBS_SMALL[letter] : THUMBS_BIG[letter];

      try{
        const img = await loadImage(src);
        // 큰장은 비율 맞추고, 작은장도 별도 이미지라 동일 처리
        const ratio = Math.min(slotW/img.width, unitH/img.height);
        const w = Math.round(img.width * ratio);
        const h = Math.round(img.height * ratio);
        const ix = x + Math.round((slotW - w)/2);
        const iy = Math.round((unitH - h)/2);
        ctx.drawImage(img, ix, iy, w, h);

        // 큰장만 중앙 간격 표시
        if(!isSmall){
          const gapPx = Math.max(1, DOOR_GAP_MM * pxPerMm);
          const mid = x + slotW/2;
          ctx.save();
          ctx.strokeStyle="#8aa3ff"; ctx.lineWidth=1; ctx.setLineDash([4,4]);
          ctx.beginPath(); ctx.moveTo(Math.round(mid-gapPx/2)+0.5, 0); ctx.lineTo(Math.round(mid-gapPx/2)+0.5, unitH); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(Math.round(mid+gapPx/2)+0.5, 0); ctx.lineTo(Math.round(mid+gapPx/2)+0.5, unitH); ctx.stroke();
          ctx.restore();
        }

      }catch(e){
        // 대체 표시
        ctx.strokeStyle="#999"; ctx.strokeRect(x+4,4,slotW-8,unitH-8);
        ctx.fillStyle="#333"; ctx.font="bold 22px system-ui"; ctx.textAlign="center";
        ctx.fillText(letter, x + slotW/2, unitH/2 + 8);
      }

      // 하단 폭 라벨
      ctx.fillStyle="#111"; ctx.font="12px system-ui"; ctx.textAlign="center";
      ctx.fillText(`${mm}mm`, x + slotW/2, unitH + labelH - 8);

      x += slotW + (i<count-1 ? gap : 0);
    }

    // Right surround
    ctx.fillStyle="#f0f0f0"; ctx.fillRect(x,0,sPx,unitH);
    ctx.strokeStyle="#cfcfcf"; ctx.strokeRect(x+0.5,0.5,sPx-1,unitH-1);
    ctx.fillStyle="#555"; ctx.font="12px system-ui"; ctx.textAlign="center";
    ctx.fillText(`R${Math.round(surround)}mm`, x + sPx/2, unitH - 6);
  }

  function loadImage(src){
    return new Promise((res,rej)=>{
      const img = new Image();
      img.onload = ()=>res(img);
      img.onerror = rej;
      img.src = src;
    });
  }

  function downloadPreview(){
    const canvas = document.getElementById('previewCanvas');
    if(!canvas || canvas.width===0){ alert("먼저 디자인을 선택하세요."); return; }
    const a = document.createElement('a');
    a.href = canvas.toDataURL("image/png");
    a.download = "최종조립미리보기.png";
    a.click();
  }

  function copyText(id){
    const t = document.getElementById(id).textContent;
    if(!t || t==='-'){ alert("먼저 시퀀스를 생성하세요."); return; }
    navigator.clipboard.writeText(t).then(()=>alert("복사됨"));
  }
</script>
</body>
</html>
